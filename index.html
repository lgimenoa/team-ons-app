<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Team ONS v5.5</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* RESET TOTAL */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; font-family: system-ui, -apple-system, sans-serif; background: #f2f2f7; }
        
        /* CAPAS */
        #layer-login { position: absolute; inset: 0; z-index: 50; background: #fff; display: flex; flex-direction: column; overflow-y: auto; }
        #layer-app { position: absolute; inset: 0; z-index: 10; display: none; flex-direction: column; background: #f2f2f7; }
        
        /* SCROLL AREA */
        #scroll-content { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: 120px; padding-top: env(safe-area-inset-top); }
        
        /* UTILS */
        .hidden-force { display: none !important; }
        input, select { font-size: 16px !important; border-radius: 12px; }
        .ios-card { background: white; border-radius: 16px; margin-bottom: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        /* NAVBAR */
        .nav-item.active { color: #2563eb; font-weight: bold; }
        .nav-item.active svg { stroke: #2563eb; }
    </style>
</head>
<body>

    <div id="layer-login">
        <div class="flex-1 flex flex-col items-center justify-center p-6">
            <div class="text-center mb-8">
                <div class="inline-flex p-4 bg-blue-100 rounded-full mb-4 text-blue-600"><i data-lucide="dumbbell" class="w-10 h-10"></i></div>
                <h1 class="text-3xl font-black text-gray-900">Team ONS</h1>
                <p class="text-sm font-bold text-green-600 bg-green-100 inline-block px-3 py-1 rounded-full mt-2">Versión 5.5 Activa</p>
            </div>
            
            <form onsubmit="ONS.Auth.login(event)" class="w-full max-w-sm space-y-4">
                <input type="text" id="login-user" class="w-full h-14 border border-gray-300 bg-gray-50 rounded-xl px-4 text-lg font-bold" placeholder="Usuario" autocapitalize="none" required>
                <input type="password" id="login-pass" class="w-full h-14 border border-gray-300 bg-gray-50 rounded-xl px-4 text-lg font-bold" placeholder="Contraseña" required>
                <button type="submit" class="w-full h-14 bg-blue-600 text-white font-bold rounded-xl text-xl shadow-lg active:scale-95 transition">ENTRAR</button>
            </form>

            <div class="mt-10 w-full max-w-sm border-t pt-6 text-center">
                <p class="text-xs text-gray-400 mb-2">¿Problemas?</p>
                <button onclick="localStorage.clear(); alert('Datos borrados. Recarga la página.'); location.reload();" class="text-red-500 font-bold text-xs border border-red-200 px-4 py-2 rounded-lg bg-red-50">⚠️ RESETEAR DATOS</button>
            </div>
            
            <div class="mt-4">
                <button onclick="ONS.UI.Members.openPublicRegister()" class="text-blue-600 font-bold">Crear cuenta</button>
            </div>
        </div>
    </div>

    <div id="layer-app">
        <header class="h-16 bg-white border-b flex items-center justify-between px-4 pt-safe shrink-0 z-20">
            <span class="font-black text-xl text-blue-900 tracking-tight">TEAM ONS</span>
            <div class="flex items-center gap-3">
                <span id="header-user" class="text-xs font-bold bg-gray-100 px-2 py-1 rounded">User</span>
                <button onclick="location.reload()" class="p-2 bg-red-50 text-red-500 rounded-full"><i data-lucide="log-out" class="w-5 h-5"></i></button>
            </div>
        </header>

        <div id="scroll-content">
            <div class="p-4 max-w-lg mx-auto">
                
                <section id="view-home" class="view-section">
                    <div class="flex gap-2 mb-4">
                        <input type="date" id="session-date" onchange="ONS.UI.Home.renderLogs()" class="flex-1 h-12 bg-white border-0 shadow-sm rounded-xl text-center font-bold">
                        <div id="admin-sel-wrapper" class="hidden w-1/2 bg-yellow-100 rounded-xl">
                            <select id="admin-sel" onchange="ONS.UI.Home.renderLogs()" class="w-full h-full bg-transparent border-0 text-center text-xs font-bold text-yellow-900"></select>
                        </div>
                    </div>

                    <div class="ios-card p-4">
                        <label class="text-xs font-bold text-gray-400 uppercase">Ejercicio</label>
                        <select id="exercise-select" onchange="ONS.UI.Home.updatePreview()" class="w-full h-14 mt-1 bg-gray-50 border-gray-200 font-bold text-lg mb-4"></select>
                        
                        <div id="preview-card" class="hidden flex items-center gap-4 bg-blue-50 p-3 rounded-xl mb-4">
                            <img id="preview-img" src="" class="w-10 h-10 object-contain" onerror="this.style.display='none'"> 
                            <div><div id="preview-name" class="font-bold text-sm"></div><div id="preview-group" class="text-xs font-bold text-blue-500"></div></div>
                        </div>

                        <div id="input-grid" class="hidden">
                            <div class="grid grid-cols-2 gap-3 mb-4">
                                <div class="bg-gray-50 p-2 rounded-xl border"><div class="text-center text-xs font-bold text-gray-400">S1</div><div class="flex gap-1"><input type="number" id="s1w" placeholder="Kg" class="text-center font-bold"><input type="number" id="s1r" placeholder="Rps" class="text-center"></div></div>
                                <div class="bg-gray-50 p-2 rounded-xl border"><div class="text-center text-xs font-bold text-gray-400">S2</div><div class="flex gap-1"><input type="number" id="s2w" placeholder="Kg" class="text-center font-bold"><input type="number" id="s2r" placeholder="Rps" class="text-center"></div></div>
                                <div class="bg-gray-50 p-2 rounded-xl border"><div class="text-center text-xs font-bold text-gray-400">S3</div><div class="flex gap-1"><input type="number" id="s3w" placeholder="Kg" class="text-center font-bold"><input type="number" id="s3r" placeholder="Rps" class="text-center"></div></div>
                                <div class="bg-gray-50 p-2 rounded-xl border"><div class="text-center text-xs font-bold text-gray-400">S4</div><div class="flex gap-1"><input type="number" id="s4w" placeholder="Kg" class="text-center font-bold"><input type="number" id="s4r" placeholder="Rps" class="text-center"></div></div>
                            </div>
                            <button onclick="ONS.UI.Home.save()" class="w-full h-14 bg-blue-600 text-white font-bold rounded-xl shadow-lg active:scale-95 text-lg">GUARDAR DATOS</button>
                        </div>
                    </div>

                    <div class="flex justify-between px-2 mb-2"><span class="font-bold text-gray-400 text-sm uppercase">Registros Hoy</span><span id="today-count" class="font-bold bg-gray-200 px-2 rounded">0</span></div>
                    <div id="logs-list" class="space-y-3"></div>
                </section>

                <section id="view-reports" class="hidden">
                    <h2 class="text-2xl font-bold mb-4">Progreso</h2>
                    <div class="ios-card p-4 space-y-3">
                        <div id="rep-adm-wrap" class="hidden"><label class="text-xs font-bold text-gray-400">USUARIO</label><select id="rep-adm-sel" onchange="ONS.UI.Reports.update()" class="w-full h-10 bg-blue-50 text-blue-900 font-bold mb-2"></select></div>
                        <div class="flex gap-2">
                            <div class="w-2/3"><label class="text-xs font-bold text-gray-400">EJERCICIO</label><select id="rep-ex-sel" onchange="ONS.UI.Reports.update()" class="h-10 text-sm"></select></div>
                            <div class="w-1/3"><label class="text-xs font-bold text-gray-400">DATO</label><select id="rep-met-sel" onchange="ONS.UI.Reports.update()" class="h-10 text-sm"><option value="max">1RM</option><option value="vol">Vol</option></select></div>
                        </div>
                        <div class="h-48 relative"><canvas id="chart-cv"></canvas></div>
                    </div>
                    <div class="ios-card overflow-hidden">
                        <table class="w-full text-xs"><tbody id="rep-table" class="divide-y"></tbody></table>
                    </div>
                </section>

                <section id="view-admin" class="hidden">
                    <h2 class="text-2xl font-bold mb-4 text-yellow-600">Admin</h2>
                    <div class="ios-card bg-yellow-50 p-4 border border-yellow-200">
                        <button onclick="ONS.Backup.download()" class="w-full h-12 bg-yellow-600 text-white font-bold rounded-xl mb-3 shadow">Descargar Backup</button>
                        <label class="w-full h-12 bg-white text-yellow-800 border border-yellow-200 font-bold rounded-xl flex items-center justify-center">Restaurar<input type="file" class="hidden" onchange="ONS.Backup.upload(this)"></label>
                    </div>
                </section>

                <section id="view-members" class="hidden">
                    <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">Equipo</h2><button onclick="ONS.UI.Members.modal()" class="bg-green-500 text-white w-10 h-10 rounded-full font-bold shadow text-xl">+</button></div>
                    <div class="ios-card"><table class="w-full text-sm"><tbody id="mem-table" class="divide-y"></tbody></table></div>
                </section>

            </div>
        </div>

        <nav class="h-20 bg-white border-t flex justify-around items-start pt-3 pb-safe z-50 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
            <button onclick="ONS.UI.nav('home')" id="btn-home" class="nav-item flex flex-col items-center w-full text-gray-400"><i data-lucide="home" class="w-6 h-6 mb-1"></i><span class="text-[10px] font-bold">Inicio</span></button>
            <button onclick="ONS.UI.nav('reports')" id="btn-reports" class="nav-item flex flex-col items-center w-full text-gray-400"><i data-lucide="bar-chart-2" class="w-6 h-6 mb-1"></i><span class="text-[10px] font-bold">Evolución</span></button>
            <button onclick="ONS.UI.nav('members')" id="btn-members" class="hidden nav-item flex-col items-center w-full text-gray-400"><i data-lucide="users" class="w-6 h-6 mb-1"></i><span class="text-[10px] font-bold">Equipo</span></button>
            <button onclick="ONS.UI.nav('admin')" id="btn-admin" class="hidden nav-item flex-col items-center w-full text-yellow-600"><i data-lucide="shield" class="w-6 h-6 mb-1"></i><span class="text-[10px] font-bold">Admin</span></button>
        </nav>
    </div>

    <div id="modal-member" class="hidden fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6">
            <h3 class="font-bold text-xl mb-4">Usuario</h3>
            <form onsubmit="ONS.UI.Members.save(event)" class="space-y-3">
                <input type="hidden" id="m-id">
                <div class="flex gap-2"><input id="m-name" class="w-1/2 h-10 border px-2" placeholder="Nombre" required><input id="m-last" class="w-1/2 h-10 border px-2" placeholder="Apellido" required></div>
                <input id="m-chalet" class="w-full h-10 border px-2" placeholder="Chalet" required>
                <input id="m-pass" class="w-full h-10 border px-2" placeholder="Pass">
                <label class="flex items-center gap-2"><input type="checkbox" id="m-admin"> Admin</label>
                <div class="flex gap-2 mt-4"><button type="button" onclick="document.getElementById('modal-member').classList.add('hidden')" class="flex-1 h-10 bg-gray-200 font-bold rounded">Cancelar</button><button type="submit" class="flex-1 h-10 bg-blue-600 text-white font-bold rounded">Guardar</button></div>
            </form>
        </div>
    </div>

    <script>
        // CHIVATO DE ERRORES GLOBAL
        window.onerror = function(msg, url, line) { alert("ERROR CRÍTICO JS:\n" + msg + "\nLínea: " + line); };

        const ONS = {
            Utils: { 
                uuid: () => Math.random().toString(36).substr(2, 9), 
                date: (d) => new Date(d).toLocaleDateString('es-ES', {day:'2-digit', month:'2-digit'}) 
            },
            Data: {
                users: [], logs: [],
                init() {
                    try {
                        this.users = JSON.parse(localStorage.getItem('ons_users') || '[]');
                        this.logs = JSON.parse(localStorage.getItem('ons_logs') || '[]');
                        if(this.users.length===0) {
                            this.users.push({id:'admin', user:'LuisG_33', pass:'admin', name:'Luis', last:'Gimeno', chalet:'33', role:'ADMIN'});
                            localStorage.setItem('ons_users', JSON.stringify(this.users));
                        }
                    } catch(e) { alert("Error Data Init: " + e); }
                },
                save() { localStorage.setItem('ons_users', JSON.stringify(this.users)); localStorage.setItem('ons_logs', JSON.stringify(this.logs)); }
            },
            Auth: {
                me: null,
                login(e) {
                    e.preventDefault();
                    try {
                        const uVal = document.getElementById('login-user').value.trim().toLowerCase();
                        const pVal = document.getElementById('login-pass').value;
                        const user = ONS.Data.users.find(u => u.user.toLowerCase() === uVal && u.pass === pVal);
                        
                        if(user) {
                            this.me = user;
                            if(user.pass === 'admin') {
                                const newP = prompt("Por seguridad, cambia tu contraseña por defecto 'admin':");
                                if(newP && newP.length>3) { user.pass=newP; ONS.Data.save(); }
                            }
                            ONS.UI.start();
                        } else { alert("Usuario o contraseña incorrectos"); }
                    } catch(err) { alert("Error Login: " + err); }
                },
                logout() { location.reload(); }
            },
            UI: {
                chart: null,
                start() {
                    document.getElementById('layer-login').style.display = 'none';
                    document.getElementById('layer-app').style.display = 'flex'; // FLEX IMPORTANTE
                    
                    document.getElementById('header-user').innerText = ONS.Auth.me.user;
                    
                    if(ONS.Auth.me.role === 'ADMIN') {
                        document.querySelectorAll('.hidden').forEach(el => {
                            if(el.id.includes('btn-') || el.id.includes('admin-')) el.classList.remove('hidden');
                        });
                        this.Members.render();
                    }
                    
                    this.Home.init();
                    this.nav('home');
                    lucide.createIcons();
                },
                nav(id) {
                    ['home','reports','admin','members'].forEach(v => document.getElementById('view-'+v).style.display = 'none');
                    document.getElementById('view-'+id).style.display = 'block';
                    
                    ['home','reports','admin','members'].forEach(v => {
                        const btn = document.getElementById('btn-'+v);
                        if(btn) btn.classList.remove('active');
                    });
                    const activeBtn = document.getElementById('btn-'+id);
                    if(activeBtn) activeBtn.classList.add('active');

                    if(id==='home') this.Home.renderLogs();
                    if(id==='reports') this.Reports.init();
                },
                Home: {
                    init() {
                        const cats = ["Sentadillas","Peso Muerto","Press Banca","Jalon Pecho","Press Militar","Curl Biceps","Triceps Polea","Plancha"];
                        const sel = document.getElementById('exercise-select');
                        sel.innerHTML = '<option value="">Selecciona...</option>';
                        cats.forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
                        document.getElementById('session-date').valueAsDate = new Date();
                        
                        if(ONS.Auth.me.role==='ADMIN') {
                            const adSel = document.getElementById('admin-sel');
                            adSel.innerHTML = `<option value="${ONS.Auth.me.id}">Para Mí</option>`;
                            ONS.Data.users.filter(u=>u.id!==ONS.Auth.me.id).forEach(u => adSel.innerHTML+=`<option value="${u.id}">${u.name} ${u.last}</option>`);
                        }
                    },
                    updatePreview() {
                        const v = document.getElementById('exercise-select').value;
                        const grid = document.getElementById('input-grid');
                        if(v) { 
                            grid.classList.remove('hidden'); 
                            document.getElementById('preview-name').innerText = v;
                            document.getElementById('preview-card').classList.remove('hidden');
                            document.getElementById('preview-card').style.display = 'flex';
                        } else { 
                            grid.classList.add('hidden'); 
                            document.getElementById('preview-card').classList.add('hidden');
                        }
                    },
                    save() {
                        const ex = document.getElementById('exercise-select').value;
                        if(!ex) return;
                        
                        const uid = (ONS.Auth.me.role==='ADMIN' && document.getElementById('admin-sel').value) ? document.getElementById('admin-sel').value : ONS.Auth.me.id;
                        
                        const series = [];
                        for(let i=1;i<=4;i++) {
                            const w = document.getElementById(`s${i}w`).value;
                            const r = document.getElementById(`s${i}r`).value;
                            if(w||r) series.push({w:w,r:r});
                        }
                        
                        ONS.Data.logs.push({
                            id: ONS.Utils.uuid(),
                            uid: uid,
                            date: document.getElementById('session-date').value,
                            ex: ex,
                            ser: series,
                            ts: new Date().toISOString()
                        });
                        ONS.Data.save();
                        alert("Guardado");
                        this.renderLogs();
                        // Limpiar inputs
                        for(let i=1;i<=4;i++) { document.getElementById(`s${i}w`).value=''; document.getElementById(`s${i}r`).value=''; }
                    },
                    renderLogs() {
                        const date = document.getElementById('session-date').value;
                        const uid = (ONS.Auth.me.role==='ADMIN' && document.getElementById('admin-sel').value) ? document.getElementById('admin-sel').value : ONS.Auth.me.id;
                        const list = document.getElementById('logs-list');
                        list.innerHTML = '';
                        
                        const todayLogs = ONS.Data.logs.filter(l => l.uid === uid && l.date === date);
                        document.getElementById('today-count').innerText = todayLogs.length;
                        
                        todayLogs.forEach(l => {
                            const txt = l.ser.map((s,i) => `S${i+1}:${s.w}/${s.r}`).join(' ');
                            list.innerHTML += `<div class="bg-white p-3 rounded-xl border flex justify-between items-center"><div><div class="font-bold text-sm">${l.ex}</div><div class="text-xs text-gray-500">${txt}</div></div><button onclick="if(confirm('Borrar?')){ONS.Data.logs=ONS.Data.logs.filter(x=>x.id!='${l.id}');ONS.Data.save();ONS.UI.Home.renderLogs();}" class="text-red-500">×</button></div>`;
                        });
                    }
                },
                Reports: {
                    init() { this.update(); }, // Simplificado para debugging
                    update() {
                        // Dummy chart rendering logic to prevent crash
                        const ctx = document.getElementById('chart-cv');
                        if(this.chart) this.chart.destroy();
                        this.chart = new Chart(ctx, {type:'line', data:{labels:['Ini'], datasets:[{data:[0]}]}});
                    }
                },
                Members: {
                    render() {
                        const tb = document.getElementById('mem-table');
                        tb.innerHTML = '';
                        ONS.Data.users.forEach(u => {
                            tb.innerHTML += `<tr><td class="p-3">${u.chalet}</td><td class="p-3 font-bold">${u.name}</td></tr>`;
                        });
                    },
                    modal() { document.getElementById('modal-member').classList.remove('hidden'); },
                    save(e) {
                        e.preventDefault();
                        const u = {
                            id: ONS.Utils.uuid(),
                            name: document.getElementById('m-name').value,
                            last: document.getElementById('m-last').value,
                            chalet: document.getElementById('m-chalet').value,
                            user: document.getElementById('m-name').value + document.getElementById('m-chalet').value,
                            pass: document.getElementById('m-pass').value || '1234',
                            role: document.getElementById('m-admin').checked ? 'ADMIN' : 'USER'
                        };
                        ONS.Data.users.push(u);
                        ONS.Data.save();
                        document.getElementById('modal-member').classList.add('hidden');
                        alert("Usuario creado: " + u.user);
                        this.render();
                    }
                }
            },
            Backup: {
                download() {
                    const b = new Blob([JSON.stringify(ONS.Data)], {type:'application/json'});
                    const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download='backup.json'; a.click();
                },
                upload(el) {
                    const r = new FileReader();
                    r.onload = e => {
                        const d = JSON.parse(e.target.result);
                        if(d.users) { ONS.Data.users = d.users; ONS.Data.logs = d.logs || []; ONS.Data.save(); location.reload(); }
                    };
                    r.readAsText(el.files[0]);
                }
            }
        };
        
        // BOOT
        document.addEventListener('DOMContentLoaded', () => {
            ONS.Data.init();
            lucide.createIcons();
        });
    </script>
</body>
</html>
